<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat y Inicio de Sesión</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
    crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/2.3.1/jsencrypt.min.js" 
    integrity="sha512-zDvrqenA0eFJZCxBsryzUZcvihvNlEXbteMv62yRxdhR4s7K1aaz+LjsRyfk6M+YJLyAJEuuquIAI8I8GgLC8A==" 
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
    <link rel="stylesheet" type="text/css" href="estilo.css">
</head>
<body>
<?php 
    require 'bd/conexion_bd.php';
    session_start();
    $obj = new BD_PDO();
?>
<div class="container">
    <h1 align="center">Inicio de Sesión</h1>
    <form action="index.html" id="formulario" name="formulario" method="post">
        <div class="form-group formulario">
            <label for="matricula">Nombre/Usuario</label>
            <input type="text" name="nombre" id="nombre" class="jsencrypt" placeholder="Nombre/Usuario" required>
            <label for="nombre">Contraseña</label>
            <input type="password" name="contra" id="contra" class="jsencrypt" placeholder="Contraseña" required>
            <input type="hidden"  name="idtoken" id="idtoken">
            <input type="hidden"  name="token" id="token" value="<?php echo trim($_SESSION['token']); ?>">
            <div>
                <div>            
                    <label for="cap">Captcha:</label>
                    <img src="captcha.php"  id="idcaptcha" alt="Captcha">
                    <input type="text" name="txtcap" id="txtcap" aria-label="Captcha" required>
                    <div id="mensaje-container" class="mt-3"></div>
                </div>
            </div>
            <br>
            <input name="insertar" id="insertar" class="btn btn-outline-primary" value="Iniciar Sesión" type="submit"> 
        </div>
    </form>
</div>
<script type="text/javascript">
    function captcha() {
        console.log("Cargando captcha............");
        $.ajax({
            url: 'captcha.php?generarcaptcha', 
            type: 'GET',
            success: function (data) {
                $("#idcaptcha").attr("src", "data:image/png;base64," + data);
            },
            error: function () {
                console.log('ERROR AL CARGAR EL CAPTCHA........');
            }
        });
    }
    var crypt = new JSEncrypt()
    crypt.setKey(`-----BEGIN PUBLIC KEY-----MIGeMA0GCSqGSIb3DQEBAQUAA4GMADCBiAKBgHinNEk0hXs9yDMPcbg2slbCM+iH0Rh+V6RTLnpSq+lflt1Py57u2Wcq07gAE5Rp7qkZJUHae99alB7aEdu3CcMjqDiYag8h1te6c5M2DkQLoPcJP0H/vWKPpgCGkqIlHhGMgOhFp5Oo6viMTjPhO+6cIRnWM8o4X0Rf/B/J5wwJAgMBAAE=-----END PUBLIC KEY-----`)
        $(document).ready(function() {
        captcha(); });
$("#formulario").submit(function (event) {
    event.preventDefault();
    $(".jsencrypt").each(function (index, element) {
        var encryptedValue = crypt.encrypt(element.value);
        console.log(element.name + " (Original):", element.value);
        console.log(element.name + " (Encriptado):", encryptedValue);
        element.value = encryptedValue;
    });
        $.post("index.php", $(this).serialize(), function (respuesta) {
            $("#mensaje-container").html(respuesta);
            if (respuesta.includes("Inicio exitoso")) {
                captcha();
            }
        });
        $(this).get(0).reset();
    });
    $.get("token.php?generartokeng", function (token) {
        $("#token").val(token);
        console.log(token);
    });
</script>
<div class="chat-widget">
    <div class="chat-header">
        <h4>Chat de Ayuda</h4>
        <button class="toggle-chat-btn">+</button>
    </div>
    <div id="chatContainer">
        <div id="chatMessages" class="chat-body"></div>
        <form id="frmMensaje" class="chat-footer" method="post">
            <input type="text" id="txtMensaje" name="txtMensaje" placeholder="Escriba su mensaje...">
            <input type="color" class="color" id="colFondo" name="colFondo">
            <input type="color" class="color" id="colTexto" name="colTexto">
            <button type="submit" id="btnEnviar">Enviar</button>
        </form>
    </div>
</div>

<script>
    $(document).ready(function(){
        var chatVisible = false;

        $(".chat-header").click(function(){
            $("#chatContainer").slideToggle();
            chatVisible = !chatVisible;
        });

        Pusher.logToConsole = true;

        var pusher = new Pusher("34091ea15b1a362fb38d", {
            cluster: "us2"
        });

        var channel = pusher.subscribe("my-channel");
        channel.bind("my-event", function(data) {
            if (data.isAdmin) {
                $("#chatMessages").append(`<div id="adminMessage" style="background-color:${data.colFondo}; color:${data.colTexto};">${data.txtMensaje}</div>`);
            } else {
                $("#chatMessages").append(`<div id="userMessage" style="background-color:${data.colFondo}; color:${data.colTexto};">${data.txtMensaje}</div>`);
            }

            $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
        });

        $("#frmMensaje").submit(function(event){
            event.preventDefault();
            $.post("paso2.php", $(this).serialize());
            $("#txtMensaje").val("");
        });
    });
</script>
<style>
    .chat-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 300px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    .chat-header {
        background-color: #333;
        color: white;
        padding: 10px;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
        display: flex;
        justify-content: space-between;
        cursor: pointer;
    }
    .chat-body {
        padding: 10px;
        height: 200px;
        overflow-y: auto;
    }
    .chat-footer {
        padding: 10px;
        display: flex;
    }
    .chat-footer input[type="text"] {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    .chat-footer button {
        padding: 8px 15px;
        background-color: #333;
        color: white;
        border: none;
        border-radius: 5px;
        margin-left: 10px;
        cursor: pointer;
    }
    .chat-footer button:hover {
        background-color: #555;
    }
    .color {
    width: 3px;
    height: 20px;
    }
    #chatContainer {
        display: none;
    }
</style>
</body>
</html>
